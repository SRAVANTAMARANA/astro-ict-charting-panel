<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Astro ICT Chart Panel</title>

  <!-- Lightweight Charts UMD bundle (required) -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    html,body{height:100%;margin:0;font-family:Arial, Helvetica, sans-serif;background:#f5f7fb}
    .header{display:flex;align-items:center;gap:8px;padding:10px;background:#fff;border-bottom:1px solid #ddd}
    .controls input, .controls select{padding:6px}
    #chart{height:520px;width:100%;background:#fff;border:1px solid #ddd}
    .right{padding:12px}
    #log{height:160px;overflow:auto;background:#fff;border:1px solid #ddd;padding:8px;font-size:12px}
    .button{padding:6px 10px;border-radius:4px;background:#0b84ff;color:#fff;border:none;cursor:pointer}
  </style>
</head>
<body>
  <div class="header">
    <div class="controls">
      Symbol: <input id="symbol" value="AAPL" />
      Interval:
      <select id="interval">
        <option value="1min">1min</option>
        <option value="5min" selected>5min</option>
        <option value="15min">15min</option>
        <option value="1h">1h</option>
        <option value="1d">1d</option>
      </select>
      <button id="load" class="button">Load</button>
      <span id="status" style="margin-left:12px">status: idle</span>
    </div>
  </div>

  <div style="display:flex;gap:12px;padding:12px">
    <div style="flex:1">
      <div id="chart"></div>
    </div>
    <div style="width:360px" class="right">
      <h4>Logs</h4>
      <div id="log">open logs...</div>
    </div>
  </div>

  <script>
    // config
    const API_BASE = (window.API_BASE || 'http://localhost:8000');
    const LOG = document.getElementById('log');
    function log(msg){ console.log(msg); LOG.innerText = (new Date()).toLocaleTimeString() + ' - ' + msg + '\n' + LOG.innerText; }

    // create chart
    const chartDiv = document.getElementById('chart');
    const createChart = window.LightweightCharts && window.LightweightCharts.createChart;
    if (!createChart) {
      log('ERROR: LightweightCharts.createChart not found. Check inclusion of the library.');
      document.getElementById('status').innerText = 'status: chart lib missing';
      throw new Error('lightweight-charts missing');
    }

    const chart = createChart(chartDiv, { width: chartDiv.clientWidth, height: 520, layout: { background: { color: '#ffffff'}, textColor: '#333' } });
    const candleSeries = chart.addCandlestickSeries({
      upColor: '#26a69a', downColor: '#ef5350', borderVisible: true, wickUpColor:'#26a69a', wickDownColor:'#ef5350'
    });

    // resize handling
    window.addEventListener('resize', ()=> {
      try {
        chart.applyOptions({ width: chartDiv.clientWidth, height: 520 });
      } catch(e){ /* ignore */ }
    });

    // helper to convert backend times to lightweight format
    function normalizeCandles(raw) {
      // Accept ISO string time or epoch seconds depending on backend
      return raw.map(c => ({
        time: c.time, // backend already returns ISO strings in your API responses
        open: +c.open, high: +c.high, low: +c.low, close: +c.close, volume: c.volume
      }));
    }

    async function fetchCandles(symbol, interval, limit=200) {
      const url = `${API_BASE}/ict/candles?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${limit}`;
      log('fetching ' + url);
      document.getElementById('status').innerText = 'status: fetching...';
      try {
        const res = await fetch(url);
        if (!res.ok) {
          const text = await res.text().catch(()=>'<no body>');
          log('fetch failed code=' + res.status + ' body=' + text);
          document.getElementById('status').innerText = 'status: fetch error ' + res.status;
          return;
        }
        const j = await res.json();
        if (!j || !Array.isArray(j.candles)) {
          log('Invalid payload from backend: ' + JSON.stringify(j).slice(0,300));
          document.getElementById('status').innerText = 'status: invalid payload';
          return;
        }

        const data = normalizeCandles(j.candles);
        candleSeries.setData(data);
        try { chart.timeScale().fitContent(); } catch(e){ /* ignore */ }
        document.getElementById('status').innerText = `status: loaded ${data.length} candles`;
        log(`Loaded ${data.length} candles for ${symbol} ${interval}`);
      } catch (err) {
        log('Fetch error: ' + (err && err.message));
        document.getElementById('status').innerText = 'status: fetch exception';
      }
    }

    // UI
    document.getElementById('load').addEventListener('click', ()=> {
      const sym = document.getElementById('symbol').value || 'AAPL';
      const intv = document.getElementById('interval').value || '1min';
      fetchCandles(sym, intv);
    });

    // load demo on open
    fetchCandles(document.getElementById('symbol').value, document.getElementById('interval').value);
  </script>
</body>
</html>
