<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Astro ICT Chart Panel</title>

  <!-- Lightweight Charts (standalone UMD bundle) -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root{
      --primary: #1a73e8;
      --panel-bg: #f5f7fb;
      --light: #ffffff;
    }
    html,body{height:100%;margin:0;font-family:Inter, Arial, sans-serif;background:var(--panel-bg);}
    .app{display:flex;flex-direction:column;height:100vh;}
    header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#fff;border-bottom:1px solid #ddd;}
    header h1{font-size:18px;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    button{padding:6px 10px;border-radius:4px;background:var(--primary);color:#fff;border:none;cursor:pointer}
    button.secondary{background:#eee;color:#111;border:1px solid #ccc}
    .main{display:flex;flex:1;gap:12px;padding:12px}
    .left{flex:1;display:flex;flex-direction:column;gap:12px}
    #chart{flex:1;min-height:380px;border:1px solid #ddd;background:var(--light)}
    .panel{background:var(--light);border:1px solid #ddd;padding:12px;height:300px;overflow:auto}
    .right{width:300px;display:flex;flex-direction:column;gap:12px}
    #log{font-size:12px;max-height:200px;overflow:auto}
    input, select {padding:6px;border:1px solid #ccc;border-radius:4px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Astro ICT Chart Panel</h1>
      <div class="controls">
        <label>Symbol:
          <input id="symbolInput" value="XAUUSD" style="padding:6px;margin-left:6px" />
        </label>
        <select id="intervalSelect" style="padding:6px">
          <option value="1min">1m</option>
          <option value="5min" selected>5m</option>
          <option value="15min">15m</option>
          <option value="60min">1h</option>
          <option value="1day">1d</option>
        </select>
        <button id="loadBtn">Load</button>
      </div>
    </header>

    <div class="main">
      <div class="left">
        <div id="chart"></div>
        <div class="panel">
          <h3>Signals</h3>
          <div id="signals">No signals yet</div>
        </div>
      </div>
      <div class="right">
        <div class="panel">
          <h3>Backend Status</h3>
          <div id="backendStatus">idle</div>
        </div>
        <div class="panel">
          <h3>Logs</h3>
          <div id="log"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = (window.API_BASE || 'http://localhost:8000');
    const POLL_INTERVAL_MS = 5000;

    let chart, candleSeries, pollTimer;

    const logEl = document.getElementById('log');
    const backendStatus = document.getElementById('backendStatus');

    function log(msg) {
      logEl.textContent = new Date().toLocaleTimeString() + " — " + msg + "\n" + logEl.textContent;
    }

    function initChart() {
      if (chart) chart.remove();
      chart = LightweightCharts.createChart(document.getElementById('chart'), {
        width: document.getElementById('chart').clientWidth,
        height: 420,
        layout: { background: { color: '#fff' }, textColor: '#000' }
      });
      candleSeries = chart.addCandlestickSeries({
        upColor: '#26a69a',
        downColor: '#ef5350',
        borderVisible: true,
        wickUpColor: '#26a69a',
        wickDownColor: '#ef5350'
      });
      window.addEventListener('resize', () => {
        chart.applyOptions({ width: document.getElementById('chart').clientWidth });
      });
    }

    async function checkBackend() {
      try {
        const res = await fetch(API_BASE + '/ict/health');
        if (!res.ok) throw new Error(res.status);
        const j = await res.json();
        backendStatus.textContent = 'ok — ' + (j.time || '');
      } catch (err) {
        backendStatus.textContent = 'error: ' + err.message;
      }
    }

    async function fetchCandles(symbol, interval) {
      try {
        const url = `${API_BASE}/ict/candles?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=200`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('server ' + res.status);
        const j = await res.json();
        if (!j || !Array.isArray(j.candles)) throw new Error('invalid payload');
        const data = j.candles.map(c => ({
          time: c.time,
          open: +c.open,
          high: +c.high,
          low: +c.low,
          close: +c.close
        }));
        candleSeries.setData(data);
        try { chart.timeScale().fitContent(); } catch(e){}
        log(`Loaded ${data.length} candles for ${symbol} ${interval}`);
      } catch (err) {
        log("Fetch error: " + err.message);
      }
    }

    function loadSymbol() {
      const symbol = document.getElementById('symbolInput').value || 'XAUUSD';
      const interval = document.getElementById('intervalSelect').value || '5min';
      if (pollTimer) clearInterval(pollTimer);
      fetchCandles(symbol, interval);
      pollTimer = setInterval(() => fetchCandles(symbol, interval), POLL_INTERVAL_MS);
      checkBackend();
    }

    document.getElementById('loadBtn').addEventListener('click', loadSymbol);
    window.addEventListener('load', () => {
      initChart();
      loadSymbol();
    });
  </script>
</body>
</html>
