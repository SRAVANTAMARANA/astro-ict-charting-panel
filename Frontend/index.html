cat > ./index.html <<'EOF'
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Astro ICT Chart Panel (TradingView)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--panel-bg:#f5f7fb;--light:#fff;--dark:#0b1220;}
    body{margin:0;font-family:Inter,Arial;background:var(--panel-bg);}
    header{display:flex;align-items:center;justify-content:space-between;padding:12px;background:#fff;border-bottom:1px solid #ddd}
    .controls{display:flex;gap:8px;align-items:center}
    input,select,button{padding:6px;border-radius:4px;border:1px solid #ccc}
    .main{display:flex;height:calc(100vh - 72px);gap:12px;padding:12px}
    .left{flex:1;display:flex;flex-direction:column}
    #tv_chart{flex:1;border:1px solid #ddd;background:var(--light);min-height:360px}
    .right{width:320px;display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--light);border:1px solid #ddd;padding:12px;overflow:auto}
  </style>
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>
<body>
  <header>
    <h1>Astro ICT Chart Panel — TradingView</h1>
    <div class="controls">
      <label>Symbol:
        <input id="symbolInput" value="XAUUSD" style="width:120px;margin-left:6px" />
      </label>
      <label>Interval:
        <select id="intervalSelect" style="margin-left:6px">
          <option value="1">1m</option>
          <option value="5" selected>5m</option>
          <option value="15">15m</option>
          <option value="60">1h</option>
          <option value="D">1d</option>
        </select>
      </label>
      <button id="loadBtn">Load</button>
      <button id="themeBtn">Dark</button>
      <button id="tvToggleBtn">Toggle TV</button>
      <button id="fullscreenBtn">Fullscreen</button>
    </div>
  </header>

  <div class="main">
    <div class="left">
      <div id="tv_chart"></div>
      <div style="display:flex;gap:12px;margin-top:12px">
        <div class="panel" style="flex:1"><h3>Signals</h3><div id="signals">No signals yet</div></div>
        <div class="panel" style="width:220px"><h3>AI Mentor</h3><div id="mentor">AI mentor demo</div></div>
      </div>
    </div>

    <div class="right">
      <div class="panel">
        <h3>Backend Status</h3>
        <div id="backendStatus">not checked</div>
      </div>
      <div class="panel">
        <h3>Logs</h3>
        <pre id="log" style="font-size:12px;max-height:280px;overflow:auto"></pre>
      </div>
    </div>
  </div>

<script>
let widget = null;
let currentTheme = 'light';
function log(msg){ const p=document.getElementById('log'); p.textContent=(new Date()).toLocaleTimeString()+' — '+msg+'\n'+p.textContent; }
function normalizeSymbol(userSymbol){
  if(!userSymbol) return 'XAUUSD';
  const s = userSymbol.trim().toUpperCase();
  if(s.indexOf(':') !== -1) return s;
  if(['XAUUSD','XAGUSD','EURUSD','GBPUSD','USDJPY'].includes(s)) return 'OANDA:'+s;
  if(/^[A-Z]{1,5}$/.test(s)) return 'NASDAQ:'+s;
  return s;
}
function createTradingViewWidget(symbolRaw, interval){
  const symbol = normalizeSymbol(symbolRaw);
  const containerId = 'tv_chart';
  const theme = (currentTheme === 'dark') ? 'dark' : 'light';
  const parent = document.getElementById(containerId).parentNode;
  const old = document.getElementById(containerId);
  const newDiv = document.createElement('div');
  newDiv.id = containerId;
  newDiv.style.height = '100%';
  newDiv.style.width = '100%';
  parent.replaceChild(newDiv, old);
  log('Creating TradingView widget: ' + symbol + ' @ ' + interval);
  widget = new TradingView.widget({
    "container_id": containerId,
    "width": "100%",
    "height": "100%",
    "symbol": symbol,
    "interval": String(interval),
    "timezone": "Etc/UTC",
    "theme": theme,
    "style": "1",
    "toolbar_bg": "#f1f3f6",
    "hide_side_toolbar": false,
    "withdateranges": true,
    "allow_symbol_change": true,
    "details": true,
    "hotlist": true,
    "calendar": true,
    "studies": ["MASimple@tv-basicstudies"],
    "locale": "en"
  });
  try{ widget.onChartReady(()=> log('TradingView chart ready: ' + symbol)); }catch(e){ log('widget created'); }
}
document.addEventListener('DOMContentLoaded', () => {
  const symbolInput=document.getElementById('symbolInput');
  const intervalSelect=document.getElementById('intervalSelect');
  const loadBtn=document.getElementById('loadBtn');
  const themeBtn=document.getElementById('themeBtn');
  const tvToggleBtn=document.getElementById('tvToggleBtn');
  const fullscreenBtn=document.getElementById('fullscreenBtn');
  createTradingViewWidget(symbolInput.value, intervalSelect.value);
  loadBtn.addEventListener('click', ()=> createTradingViewWidget(symbolInput.value, intervalSelect.value));
  intervalSelect.addEventListener('change', ()=> createTradingViewWidget(symbolInput.value, intervalSelect.value));
  themeBtn.addEventListener('click', ()=> { currentTheme=(currentTheme==='dark')?'light':'dark'; themeBtn.textContent=(currentTheme==='dark')?'Light':'Dark'; createTradingViewWidget(symbolInput.value, intervalSelect.value); });
  tvToggleBtn.addEventListener('click', ()=> { const tv=document.getElementById('tv_chart'); tv.style.display=(tv.style.display==='none')?'block':'none'; });
  fullscreenBtn.addEventListener('click', ()=> { const el=document.getElementById('tv_chart'); if(!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.(); });
  setInterval(async ()=> {
    try { const resp = await fetch('/ict/health'); const j = await resp.json(); document.getElementById('backendStatus').textContent = j.status || JSON.stringify(j); } 
    catch(err){ document.getElementById('backendStatus').textContent = 'down'; }
  }, 5000);
});
</script>
</body>
</html>
EOF
