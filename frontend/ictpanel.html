<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Astro ICT Chart Panel â€” Dual (Lightweight + TradingView)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; height:100vh; display:flex; flex-direction:column; }
    header { padding:10px; background:#f4f6f8; display:flex; align-items:center; gap:10px; }
    #buttons { margin-left:auto; display:flex; gap:8px; }
    #main { flex:1; display:flex; gap:8px; padding:8px; box-sizing:border-box; }
    .panel { flex:1; border:1px solid #ddd; border-radius:6px; overflow:hidden; background:white; position:relative; }
    #chart, #tradingview_container { width:100%; height:100%; }
    .hidden { display:none; }
    .note { padding:8px; font-size:13px; color:#666 }
  </style>
</head>
<body>

<header>
  <h3 style="margin:0">Astro ICT Chart Panel</h3>
  <div id="buttons">
    <button id="btn-light">Lightweight Chart</button>
    <button id="btn-tv">TradingView Chart</button>
    <button id="btn-refresh">Refresh Chart</button>
  </div>
</header>

<div id="main">
  <div class="panel" id="lw-panel">
    <div id="chart"></div>
    <div class="note">Lightweight Charts (local). If empty, check console for errors.</div>
  </div>
  <div class="panel hidden" id="tv-panel">
    <div id="tradingview_container"></div>
    <div class="note">TradingView widget embed (external).</div>
  </div>
</div>

<!-- Lightweight Charts standalone (non-module) - must load BEFORE our app logic that calls createChart -->
<script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>

<!-- TradingView embeddable (public widget) -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

<script>
/* app inline - safe startup for lightweight and TradingView toggle */
(function(){
  const btnLight = document.getElementById('btn-light');
  const btnTV = document.getElementById('btn-tv');
  const btnRefresh = document.getElementById('btn-refresh');
  const lwPanel = document.getElementById('lw-panel');
  const tvPanel = document.getElementById('tv-panel');
  const chartDiv = document.getElementById('chart');

  // Keep references for debugging
  window.__ICT = window.__ICT || {};

  // --- LIGHTWEIGHT CHARTS SAFE START ---
  async function startLightweight() {
    // wait for factory to appear (small timeout)
    let tries = 0;
    while (tries < 25 && !(window.createChart || (window.LightweightCharts && window.LightweightCharts.createChart))) {
      await new Promise(r=>setTimeout(r, 100));
      tries++;
    }
    const factory = window.createChart || (window.LightweightCharts && window.LightweightCharts.createChart);
    if (!factory) {
      console.error('[ICT] Lightweight factory not found. Make sure standalone bundle loaded.');
      return;
    }

    // Clean previous
    if (window.__ICT.chart) {
      try { window.__ICT.chart.remove(); } catch(e){ console.warn('existing chart remove failed', e); }
      window.__ICT = {};
    }

    // create chart instance
    const chart = factory(chartDiv, {
      width: chartDiv.clientWidth,
      height: chartDiv.clientHeight,
      layout: { background: { color: '#ffffff' }, textColor: '#333' },
      rightPriceScale: { borderVisible: false },
      timeScale: { borderVisible: false }
    });

    // ensure addCandlestickSeries is available
    if (typeof chart.addCandlestickSeries !== 'function') {
      console.error('[ICT] chart.addCandlestickSeries is not a function. chart prototype keys:', Object.getOwnPropertyNames(Object.getPrototypeOf(chart)));
      return;
    }

    const candleSeries = chart.addCandlestickSeries();
    window.__ICT.chart = chart;
    window.__ICT.candleSeries = candleSeries;

    // Put small demo data (replace with real server data later)
    candleSeries.setData([
      { time: '2025-09-23T15:35:00Z', open: 1930, high:1935, low:1927, close:1932 },
      { time: '2025-09-23T15:40:00Z', open: 1932, high:1936, low:1930, close:1934 },
      { time: '2025-09-23T15:45:00Z', open: 1934, high:1938, low:1931, close:1936 }
    ]);

    chart.timeScale().fitContent();

    // handle resize
    window.addEventListener('resize', ()=> {
      try {
        chart.applyOptions({ width: chartDiv.clientWidth, height: chartDiv.clientHeight });
      } catch(e){}
    });

    console.log('[ICT] Lightweight chart created and demo candles loaded.');
  }

  // --- TRADINGVIEW WIDGET START ---
  function startTradingView() {
    // If TradingView not yet ready, tv.js sets window.TradingView - check
    if (typeof window.TradingView === 'undefined') {
      console.warn('[ICT] TradingView widget script not ready yet.');
      // still attempt instantiate after short delay
      setTimeout(startTradingView, 300);
      return;
    }

    // clear container then initialize widget (use public widget config)
    const container = document.getElementById('tradingview_container');
    container.innerHTML = '';
    new TradingView.MediumWidget({
      "container_id": "tradingview_container",
      "symbols": [
        ["XAUUSD|1", "XAUUSD"],
        ["BTCUSD|1", "BTCUSD"]
      ],
      "greyText": "Regular",
      "gridLineColor": "#e9e9ea",
      "fontColor": "#83888D",
      "underLineColor": "#e9e9ea",
      "trendLineColor": "#2196F3",
      "width": "100%",
      "height": "100%",
      "locale": "en",
      "dateRange": "3D",
      "chartType": "line",
      "autosize": true,
      "showVolume": false,
      "hideDateRanges": false,
      "showMA": false,
      "showTitle": true,
      "showSymbolLogo": true,
      "scalePosition": "right",
      "scaleMode": "Normal",
      "fontFamily": "-apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif",
      "noTimeScale": false,
      "valuesTracking": "1"
    });
    console.log('[ICT] TradingView widget started.');
  }

  // --- UI toggle handlers ---
  btnLight.onclick = async () => {
    tvPanel.classList.add('hidden');
    lwPanel.classList.remove('hidden');
    // if no chart yet, start
    if (!window.__ICT.chart) await startLightweight();
  };
  btnTV.onclick = () => {
    lwPanel.classList.add('hidden');
    tvPanel.classList.remove('hidden');
    // start tradingview if not present
    startTradingView();
  };
  btnRefresh.onclick = async () => {
    // refresh whichever view is visible
    if (!lwPanel.classList.contains('hidden')) {
      await startLightweight();
    } else {
      startTradingView();
    }
  };

  // Start with Lightweight by default (safe)
  btnLight.click();

  // expose quick debug helper
  window.__ICT.startLightweight = startLightweight;
  window.__ICT.startTradingView = startTradingView;

})();
</script>
</body>
</html>
