<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Astro ICT Chart Panel — Fixed + MA/EMA/FVG</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Use an explicit lightweight-charts version (production bundle). -->
  <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

  <style>
    :root{--bg:#f3f7fb;--panel:#fff;--accent:#0b57a4;--muted:#7a8a99;--good:#0b8a3e;--bad:#c0392b}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(#eaf3ff,#f7fbff)}
    header{background:var(--accent);color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:18px}
    #root{display:flex;gap:12px;padding:12px}
    #left{width:360px;min-width:240px;display:flex;flex-direction:column;gap:12px}
    .card{background:var(--panel);border-radius:8px;padding:12px;box-shadow:0 6px 20px rgba(11,87,164,0.06)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,select,button{font-size:14px;padding:6px 8px;border-radius:6px;border:1px solid #d6e2ef}
    button{background:var(--accent);color:#fff;border:none;cursor:pointer}
    button.secondary{background:#fff;color:var(--accent);border:1px solid #d6e2ef}
    button.ghost{background:transparent;color:var(--accent);border:1px dashed #cfe1fb}
    #chartColumn{flex:1;display:flex;flex-direction:column;gap:12px}
    #chartCard{display:flex;flex-direction:column;min-height:460px}
    #chart{width:100%;height:520px}
    #floatingInfo{position:absolute;right:12px;top:12px;background:rgba(255,255,255,0.95);padding:8px;border-radius:8px}
    #tvOverlay{position:absolute;left:0;right:0;top:0;bottom:0;background:#fff;display:none;z-index:40}
    #tray{position:fixed;right:16px;bottom:16px;background:var(--panel);box-shadow:0 10px 30px rgba(6,29,51,0.12);border-radius:8px;padding:8px;width:320px;max-height:70vh;overflow:auto;transform:translateY(110%);transition:all .25s}
    #tray.open{transform:translateY(0)}
    .miniBtn{padding:6px;border-radius:6px;border:1px solid #e4eefb;background:#fff;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    pre{background:#f6fbff;padding:8px;border-radius:6px;max-height:200px;overflow:auto}
    @media (max-width:900px){#left{display:none}}
  </style>
</head>
<body>
  <header><h1>Astro ICT Chart Panel — Fixed</h1><div class="muted" style="margin-left:8px">Backend must be running &lt;— change BACKEND_BASE if needed</div></header>

  <div id="root">
    <div id="left">
      <div class="card">
        <strong>Controls</strong>
        <div class="row" style="margin-top:8px">
          <label>Symbol <input id="symbol" value="XAUUSD"/></label>
          <label>Interval
            <select id="interval">
              <option value="1min">1m</option>
              <option value="5min" selected>5m</option>
              <option value="15min">15m</option>
              <option value="1h">1h</option>
            </select>
          </label>
          <label>Limit<input id="limit" value="200" style="width:100px" /></label>
        </div>

        <div class="row" style="margin-top:8px">
          <button id="loadBtn">Load</button>
          <button id="autoBtn" class="secondary">Auto-refresh</button>
          <button id="tvBtn" class="ghost">TV</button>
          <button id="fullscreenBtn" class="secondary">Fullscreen</button>
        </div>

        <div style="margin-top:8px" class="muted">Status: <span id="status">idle</span></div>
      </div>

      <div class="card">
        <strong>Indicators</strong>
        <div class="row" style="margin-top:8px">
          <label><input type="checkbox" id="maToggle" checked /> MA (20)</label>
          <label><input type="checkbox" id="emaToggle" checked /> EMA (50)</label>
          <label><input type="checkbox" id="fvgToggle" /> FVG (simple)</label>
        </div>
      </div>

      <div class="card">
        <strong>AI & Signals</strong>
        <div class="muted" style="margin-top:6px">Demo AI mentor + signals tray</div>
        <div style="margin-top:8px" class="row">
          <button id="refreshSignals" class="secondary">Refresh</button>
          <button id="genSignal" class="ghost">Create demo signal</button>
          <button id="clearSignals" class="ghost">Clear</button>
        </div>
        <div id="signalsList" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <strong>Logs</strong>
        <pre id="logPre"></pre>
      </div>
    </div>

    <div id="chartColumn">
      <div class="card" id="chartCard">
        <div style="display:flex;align-items:center;gap:12px;padding-bottom:8px">
          <div><strong id="headerSymbol">XAUUSD</strong></div>
          <div class="muted" id="headerInterval">5m</div>
          <div style="flex:1"></div>
          <div class="muted">Min/Max: <span id="minmax">—</span></div>
        </div>

        <div id="chartContainer" style="position:relative">
          <div id="chart"></div>
          <div id="tvOverlay"><button id="closeTv" class="miniBtn" style="position:absolute;right:8px;top:8px;z-index:50">Close TV</button><iframe id="tvFrame" style="width:100%;height:100%;border:0"></iframe></div>

          <div id="floatingInfo" style="position:absolute;top:12px;right:12px;">
            <div><strong>Floating</strong></div>
            <div class="muted">Last: <span id="floatingLast">—</span></div>
            <div class="muted">Min: <span id="floatingMin">—</span></div>
            <div class="muted">Max: <span id="floatingMax">—</span></div>
            <div style="margin-top:6px"><button id="exportBtn" class="miniBtn">Export CSV</button> <button id="addMarkerBtn" class="miniBtn">Add Marker</button></div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="tray" class="card"><div style="display:flex;justify-content:space-between;align-items:center"><strong>Signals Tray</strong><button id="trayToggle" class="miniBtn">Open</button></div><div id="trayBody" style="margin-top:8px"></div></div>

<script>
/* ================= CONFIG ================= */
const BACKEND_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1') ? 'http://localhost:8000' : `${location.protocol}//${location.hostname}:8000`;
const DEFAULT_LIMIT = 200;

/* ================= SAFE LWC reference ================= */
/* Some bundles expose different globals — pick the available one */
const LWC = window.LightweightCharts || window.lightweightCharts || window.lightweightChartsStandalone || window.lightweightCharts || (window && window['lightweight-charts']);
if(!LWC){
  alert('LightweightCharts not found. Check script include.');
  throw new Error('LightweightCharts not loaded');
}

/* ================= Helpers ================= */
const $ = id => document.getElementById(id);
const log = (...args) => {
  console.log(...args);
  const pre = $('logPre');
  pre.textContent += `[${new Date().toLocaleTimeString()}] ` + args.map(a => (typeof a==='object'?JSON.stringify(a):a)).join(' ') + "\n";
  pre.scrollTop = pre.scrollHeight;
};
function persistGet(k,d){ try{ const v=JSON.parse(localStorage.getItem(k)); return v===null?d:v }catch(e){ return d } }
function persistSet(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

/* ================= State ================= */
let chart = null;
let candleSeries = null;
let maSeries = null;
let emaSeries = null;
let fvgWidgets = []; // rectangles
let lastCandles = [];
let markers = [];
let autoTimer = null;

/* ================= Chart creation (after DOM ready) ================= */
function createChart(){
  const container = $('chart');
  container.innerHTML = '';
  const rect = container.getBoundingClientRect();
  chart = LWC.createChart(container, {
    width: Math.max(600, Math.floor(rect.width)),
    height: Math.max(320, Math.floor(rect.height)),
    layout: { backgroundColor:'#ffffff', textColor: '#111' },
    timeScale: { timeVisible: true, secondsVisible: false },
    rightPriceScale: { scaleMargins: { top: 0.1, bottom: 0.1 } }
  });
  candleSeries = chart.addCandlestickSeries({
    upColor: '#0b8a3e', downColor: '#c0392b', wickUpColor: '#0b8a3e', wickDownColor: '#c0392b'
  });
  maSeries = chart.addLineSeries({ color:'#1f78ff', lineWidth:2, priceLineVisible:false });
  emaSeries = chart.addLineSeries({ color:'#ff7f0e', lineWidth:2, priceLineVisible:false });
  // handle resize
  window.addEventListener('resize', ()=> {
    if(!chart) return;
    const r = container.getBoundingClientRect();
    chart.applyOptions({ width: Math.floor(r.width), height: Math.floor(r.height) });
  });
  // update minmax on time range change
  chart.timeScale().subscribeVisibleTimeRangeChange(()=>{
    computeMinMax();
    updateFloating();
  });
  return chart;
}
document.addEventListener('DOMContentLoaded', ()=> {
  createChart();
  // initial load using persisted values
  const sym = persistGet('ict_symbol','XAUUSD');
  $('symbol').value = sym;
  $('interval').value = persistGet('ict_interval','5min');
  $('limit').value = persistGet('ict_limit', DEFAULT_LIMIT);
  $('headerSymbol').textContent = $('symbol').value;
  $('headerInterval').textContent = $('interval').value;
  $('loadBtn').click();
});

/* ================= Utilities / Data transforms ================= */
function normalizeToLW(c){
  // lightweight accepts numeric UNIX seconds or ISO strings. We'll use UNIX seconds.
  const t = (typeof c.time === 'number') ? c.time : Math.floor(new Date(c.time).getTime()/1000);
  return { time: t, open: Number(c.open), high: Number(c.high), low: Number(c.low), close: Number(c.close) };
}

async function fetchCandles(symbol, interval, limit=200){
  try{
    $('status').textContent = 'fetching';
    const url = `${BACKEND_BASE}/ict/candles?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${limit}`;
    const r = await fetch(url);
    if(!r.ok){
      const txt = await r.text();
      log('fetch error', r.status, txt);
      $('status').textContent = `backend ${r.status}`;
      return [];
    }
    const j = await r.json();
    return j.candles || [];
  }catch(e){
    log('fetchCandles', e.message);
    $('status').textContent = 'fetch failed';
    return [];
  }
}

/* ================= Render ================= */
function renderCandles(candles){
  if(!chart) createChart();
  const lw = candles.map(normalizeToLW);
  candleSeries.setData(lw);
  lastCandles = candles;
  computeMinMax();
  updateFloating();
  computeIndicatorsAndDraw();
  drawMarkers();
  $('status').textContent = `rendered ${lw.length}`;
}

/* ================= Min/Max/floating ================= */
function computeMinMax(){
  try{
    const vr = chart.timeScale().getVisibleRange();
    if(!vr) return;
    const from = vr.from; const to = vr.to;
    const bars = lastCandles.filter(c => {
      const t = Math.floor(new Date(c.time).getTime()/1000);
      return t >= from && t <= to;
    });
    if(bars.length===0){ $('minmax').textContent = '—'; return; }
    const highs = bars.map(b => Number(b.high));
    const lows = bars.map(b => Number(b.low));
    const mx = Math.max(...highs); const mn = Math.min(...lows);
    $('minmax').textContent = `${mn.toFixed(4)} / ${mx.toFixed(4)}`;
    $('floatingMax').textContent = mx.toFixed(4);
    $('floatingMin').textContent = mn.toFixed(4);
  }catch(e){ log('computeMinMax', e.message); }
}
function updateFloating(){
  if(!lastCandles.length) return;
  const last = lastCandles[lastCandles.length-1];
  $('floatingLast').textContent = Number(last.close).toFixed(4);
}

/* ================= Indicators: MA, EMA, FVG ================= */
function sma(values, period){
  if(values.length < period) return [];
  const out = [];
  let sum = 0;
  for(let i=0;i<values.length;i++){
    sum += values[i];
    if(i >= period) sum -= values[i-period];
    if(i >= period-1) out.push( Number((sum/period).toFixed(6)) );
  }
  return out;
}
function ema(values, period){
  const k = 2/(period+1);
  const out = [];
  let prev = null;
  for(let i=0;i<values.length;i++){
    const v = values[i];
    if(prev === null){ prev = v; out.push(v); continue; }
    prev = prev * (1-k) + v * k;
    out.push(Number(prev.toFixed(6)));
  }
  return out;
}
function computeIndicatorsAndDraw(){
  if(!lastCandles || lastCandles.length===0) return;
  // build closes array
  const closes = lastCandles.map(c => Number(c.close));
  // MA(20)
  if($('maToggle').checked){
    const maPeriod=20;
    const mavals = sma(closes, maPeriod);
    // align times: sma starts at index period-1
    const points = [];
    for(let i=maPeriod-1;i<lastCandles.length;i++){
      const ts = Math.floor(new Date(lastCandles[i].time).getTime()/1000);
      points.push({ time: ts, value: mavals[i-(maPeriod-1)] });
    }
    maSeries.setData(points);
    maSeries.applyOptions({ visible: true });
  } else {
    maSeries.setData([]);
    maSeries.applyOptions({ visible: false });
  }

  // EMA(50)
  if($('emaToggle').checked){
    const emaPeriod=50;
    const emavals = ema(closes, emaPeriod);
    const points = [];
    for(let i=0;i<emavals.length;i++){
      const ts = Math.floor(new Date(lastCandles[i].time).getTime()/1000);
      points.push({ time: ts, value: emavals[i] });
    }
    emaSeries.setData(points);
    emaSeries.applyOptions({ visible: true });
  } else {
    emaSeries.setData([]);
    emaSeries.applyOptions({ visible: false });
  }

  // Simple FVG: identify gaps between high/low of consecutive candles where difference > threshold
  // We'll create lightweight "priceLine" rectangles by using price scale marks via series? lightweight-charts doesn't support rectangles directly;
  // Instead we'll add circle markers with large text as highlight or add a histogram/area series with transparent fill. For simplicity, we'll produce markers showing FVG zones top/bottom.
  fvgWidgets.forEach(w=> chart.removePriceLine && chart.removePriceLine(w) ); // harmless attempt
  fvgWidgets = [];
  if($('fvgToggle').checked){
    // heuristic: if previous candle high < next candle low -> upward gap (rare), or previous low > next high -> downward gap
    for(let i=1;i<lastCandles.length;i++){
      const prev = lastCandles[i-1], cur = lastCandles[i];
      const prevHigh = Number(prev.high), prevLow = Number(prev.low);
      const curHigh = Number(cur.high), curLow = Number(cur.low);
      // gap up
      if(curLow > prevHigh * 1.0001){
        // mark as supply gap (bull)
        markers.push({ id:'fvg'+i, time: cur.time, position:'belowBar', color:'#b7f1d6', shape:'circle', text:'FVG up' });
      }
      // gap down
      if(curHigh < prevLow * 0.9999){
        markers.push({ id:'fvg'+i, time: cur.time, position:'aboveBar', color:'#ffd9d9', shape:'circle', text:'FVG down' });
      }
    }
    drawMarkers();
  }
}

/* ================= Markers ================= */
function drawMarkers(){
  if(!candleSeries) return;
  const m = markers.map(mk=>{
    const time = (typeof mk.time === 'number') ? mk.time : Math.floor(new Date(mk.time).getTime()/1000);
    return {
      time,
      position: mk.position || 'aboveBar',
      color: mk.color || '#1f78ff',
      shape: mk.shape || 'circle',
      id: mk.id || Math.random().toString(36).slice(2,8),
      text: mk.text || ''
    };
  });
  candleSeries.setMarkers(m);
}

/* ================= Fetch + UI bindings ================= */
$('loadBtn').addEventListener('click', async ()=>{
  persistSet('ict_symbol', $('symbol').value);
  persistSet('ict_interval', $('interval').value);
  persistSet('ict_limit', Number($('limit').value));
  $('headerSymbol').textContent = $('symbol').value;
  $('headerInterval').textContent = $('interval').value;
  const candles = await fetchCandles($('symbol').value, $('interval').value, Number($('limit').value||DEFAULT_LIMIT));
  if(candles.length===0){ log('no candles'); $('status').textContent = 'no data'; return; }
  renderCandles(candles);
});

/* auto-refresh */
$('autoBtn').addEventListener('click', ()=>{
  const current = persistGet('ict_auto','off');
  if(current === 'off'){
    const s = prompt('Auto-refresh seconds (>=5)', '15');
    const secs = Math.max(5, Number(s)||0);
    persistSet('ict_auto', secs);
    startAuto(secs);
  } else {
    stopAuto();
  }
});
function startAuto(sec){
  stopAuto();
  autoTimer = setInterval(()=> $('loadBtn').click(), sec*1000);
  persistSet('ict_auto', sec);
  $('status').textContent = `auto ${sec}s`;
}
function stopAuto(){ if(autoTimer) clearInterval(autoTimer); autoTimer=null; persistSet('ict_auto','off'); $('status').textContent='auto off'; }
const persistedAuto = persistGet('ict_auto','off');
if(persistedAuto !== 'off') startAuto(Number(persistedAuto));

/* TV */
$('tvBtn').addEventListener('click', ()=>{
  const ov = $('tvOverlay');
  if(ov.style.display === 'block'){ ov.style.display='none'; $('tvFrame').src=''; return;}
  const sym = $('symbol').value || 'XAUUSD';
  $('tvFrame').src = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(sym)}`;
  ov.style.display = 'block';
});
$('closeTv').addEventListener('click', ()=>{ $('tvOverlay').style.display='none'; $('tvFrame').src=''; });

/* fullscreen */
$('fullscreenBtn').addEventListener('click', ()=>{
  const card = $('chartCard');
  if(!card.classList.contains('fs')){ card.classList.add('fs'); card.style.position='fixed'; card.style.left='0';card.style.top='0';card.style.width='100%';card.style.height='100%';card.style.zIndex=9999; chart && chart.applyOptions({ width: card.clientWidth, height: card.clientHeight }); }
  else { card.classList.remove('fs'); card.style.position=''; card.style.left='';card.style.top='';card.style.width='';card.style.height='';card.style.zIndex=''; chart && chart.applyOptions({ width: $('chart').clientWidth, height: $('chart').clientHeight }); }
});

/* add marker */
$('addMarkerBtn').addEventListener('click', ()=>{
  if(!lastCandles.length) return alert('No candles');
  const last = lastCandles[lastCandles.length-1];
  markers.push({ id:Math.random().toString(36).slice(2,8), time:last.time, position:'aboveBar', color:'#ff8a00', shape:'arrowUp', text:'ICT' });
  drawMarkers();
});

/* export csv */
$('exportBtn').addEventListener('click', ()=>{
  if(!lastCandles.length) return alert('no data');
  const rows = [['time','open','high','low','close','volume']];
  for(const c of lastCandles) rows.push([c.time,c.open,c.high,c.low,c.close,c.volume||0]);
  const csv = rows.map(r=>r.map(v=>typeof v==='string'?`"${v.replace(/"/g,'""')}"`:v).join(',')).join('\n');
  const blob = new Blob([csv], { type:'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = `${$('symbol').value||'data'}.csv`; a.click();
  URL.revokeObjectURL(url);
});

/* signals demo */
function renderSignalsList(){
  const store = persistGet('ict_signals', []);
  const el = $('signalsList'); el.innerHTML='';
  if(!store.length) { el.innerHTML = '<div class="muted">No signals</div>'; return; }
  store.forEach(s=>{
    const d = document.createElement('div'); d.style.marginBottom='6px';
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${s.title}</strong><div class="muted">${s.text}</div></div><div><small>${new Date(s.time).toLocaleString()}</small></div></div>`;
    el.appendChild(d);
  });
}
$('genSignal').addEventListener('click', ()=>{
  const data = persistGet('ict_signals', []);
  const s = { id:Math.random().toString(36).slice(2,8), type:Math.random()>0.5?'buy':'sell', title:'Demo', text:'Demo signal', time:new Date().toISOString()};
  data.unshift(s);
  persistSet('ict_signals', data);
  renderSignalsList();
  // push marker
  if(lastCandles.length) markers.push({ id:'sig'+s.id, time:lastCandles[lastCandles.length-1].time, position:s.type==='buy'?'belowBar':'aboveBar', color: s.type==='buy'?'#0b8a3e':'#c0392b', shape: s.type==='buy'?'arrowUp':'arrowDown', text:s.type.toUpperCase()});
  drawMarkers();
});
$('clearSignals').addEventListener('click', ()=>{ persistSet('ict_signals', []); renderSignalsList(); markers=[]; drawMarkers(); });
$('refreshSignals').addEventListener('click', ()=>{ renderSignalsList(); });

renderSignalsList();

/* tray */
$('trayToggle').addEventListener('click', ()=> {
  const t = $('tray'); if(t.classList.contains('open')) t.classList.remove('open'); else { t.classList.add('open'); $('trayBody').innerHTML = JSON.stringify(persistGet('ict_signals',[]), null, 2); }
});

/* indicator toggles recompute */
$('maToggle').addEventListener('change', computeIndicatorsAndDraw);
$('emaToggle').addEventListener('change', computeIndicatorsAndDraw);
$('fvgToggle').addEventListener('change', computeIndicatorsAndDraw);

/* ================= Health check ================= */
async function healthCheck(){
  try{
    const r = await fetch(`${BACKEND_BASE}/ict/health`);
    if(r.ok){ $('status').textContent = 'backend OK'; log('health OK'); } else { $('status').textContent = 'health err '+r.status; log('health err', r.status); }
  }catch(e){ $('status').textContent = 'backend unreachable'; log('health err', e.message); }
}
setInterval(healthCheck, 30_000);
healthCheck();

/* ================= MAIN: load button fetches then render ================= */
async function mainLoad(){
  const symbol = $('symbol').value || 'XAUUSD';
  const interval = $('interval').value || '5min';
  const limit = Number($('limit').value || DEFAULT_LIMIT);
  $('status').textContent = 'loading';
  try{
    const candles = await fetchCandles(symbol, interval, limit);
    if(!candles || candles.length===0){ $('status').textContent='no data'; log('no candles'); return; }
    renderCandles(candles);
  }catch(e){ log('mainLoad', e.message); $('status').textContent='error'; }
}
$('loadBtn').addEventListener('click', mainLoad);

/* attempt to auto-run if persisted */
(function initAuto(){
  const a = persistGet('ict_auto','off');
  if(a !== 'off'){ startAuto(Number(a)); }
})();

/* ================= Defensive: log uncaught errors to UI ================= */
window.addEventListener('error', (ev)=> {
  log('UNCAUGHT ERROR', ev.message, ev.filename, ev.lineno);
});

/* ================= compute indicators on any load/render ================= */
/* computeIndicatorsAndDraw called in renderCandles */

/* ================= END ================= */
</script>

</body>
</html>
