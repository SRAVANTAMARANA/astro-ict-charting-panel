<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Astro ICT Chart Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body { height:100%; margin:0; font-family:Arial,Helvetica,sans-serif; background:#f6f9fc; }
    header { background:#072b55; color:#fff; padding:14px; display:flex; align-items:center; gap:12px;}
    header h1 { font-size:18px; margin:0; }
    #controls { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .btn { padding:6px 10px; border-radius:4px; border:0; cursor:pointer; background:#0b69ff; color:#fff; }
    .btn.secondary { background:#ffffff; color:#0b69ff; border:1px solid #0b69ff; }
    #layout { display:flex; height:calc(100% - 60px); gap:10px; padding:10px; box-sizing:border-box; }
    #left { flex:1 1 70%; min-width:300px; display:flex; flex-direction:column; gap:8px; }
    #chart-wrap { position:relative; flex:1; background:#fff; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.08); overflow:hidden; }
    #chart { width:100%; height:100%; }
    #chart-toolbar { display:flex; gap:8px; padding:8px; align-items:center; border-bottom:1px solid #eee; background:linear-gradient(180deg,#fff, #fbfdff); }
    input[type="text"], select { padding:6px 8px; border-radius:4px; border:1px solid #ddd; }
    #right { width:320px; min-width:220px; display:flex; flex-direction:column; gap:8px; }
    .panel { background:#fff; padding:10px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
    .panel h3 { margin:0 0 8px 0; font-size:14px; color:#073659; display:flex; align-items:center; justify-content:space-between; }
    .signals-body { max-height:360px; overflow:auto; padding-top:6px; }
    .signal { padding:8px; border-radius:6px; margin-bottom:8px; background:#f1f8ff; border-left:4px solid #0b69ff; }
    .metrics { display:flex; gap:12px; margin-left:8px; color:#073659; }
    .metric { font-size:13px; }
    .draggable { cursor:move; user-select:none; }
    #tvContainer { width:100%; height:520px; display:none; background:#fff; border-radius:6px; overflow:hidden; }
    #fullscreenBtn { position:absolute; right:8px; top:8px; z-index:10; }
    #status { padding:6px 10px; color:#666; font-size:13px; }
    /* small responsive */
    @media (max-width:900px){
      #layout { flex-direction:column; }
      #right { width:100%; }
    }
  </style>
  <!-- Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
  <header>
    <h1>Astro ICT Chart Panel</h1>
    <div id="controls">
      <label>Symbol <input id="symbol" type="text" value="XAUUSD" /></label>
      <label>TV Interval
        <select id="interval">
          <option value="1min">1m</option>
          <option value="5min" selected>5m</option>
          <option value="15min">15m</option>
          <option value="1h">1h</option>
        </select>
      </label>
      <button id="loadBtn" class="btn">Load</button>
      <button id="toggleTV" class="btn secondary">TV</button>
      <button id="fullscreen" class="btn secondary" title="Fullscreen">Fullscreen</button>
    </div>
  </header>

  <div id="layout">
    <div id="left">
      <div id="chart-wrap" class="panel">
        <div id="chart-toolbar">
          <div><strong id="titleSymbol">XAUUSD</strong></div>
          <div class="metrics" style="margin-left:16px;">
            <div class="metric">Max: <span id="maxVal">-</span></div>
            <div class="metric">Min: <span id="minVal">-</span></div>
            <div class="metric">Close: <span id="closeVal">-</span></div>
          </div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
            <label style="font-size:13px;color:#555">Lightweight</label>
          </div>
        </div>

        <div id="chart" ></div>
        <button id="fullscreenBtn" class="btn secondary" style="display:none">Exit Fullscreen</button>
        <div id="tvContainer"></div>
      </div>

      <div id="status" class="panel">Status: <span id="statusText">idle</span></div>
    </div>

    <div id="right">
      <div class="panel">
        <h3>AI Mentor <button id="refreshMentor" class="btn secondary">Refresh</button></h3>
        <div id="mentorText">AI mentor demo text. (Integrate your AI model / TTS later.)</div>
      </div>

      <div class="panel" id="signalsPanel">
        <h3 class="draggable">Signals <button id="showHideSignals" class="btn secondary" style="font-size:12px;">Hide</button></h3>
        <div class="signals-body" id="signalsBody">
          <div class="signal">No signals loaded yet</div>
        </div>
      </div>

      <div class="panel">
        <h3>Quick Tools</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button id="btnMaxMin" class="btn secondary">Show Max/Min</button>
          <button id="btnExportCSV" class="btn secondary">Export CSV</button>
          <button id="btnToggleTheme" class="btn secondary">Dark</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // ----- CONFIG -----
    const BACKEND_BASE = 'http://localhost:8000'; // change if backend different host/port
    const chartContainer = document.getElementById('chart');
    const tvContainer = document.getElementById('tvContainer');
    const statusText = document.getElementById('statusText');
    const symbolInput = document.getElementById('symbol');
    const intervalSelect = document.getElementById('interval');
    const loadBtn = document.getElementById('loadBtn');
    const toggleTVBtn = document.getElementById('toggleTV');
    const showHideSignalsBtn = document.getElementById('showHideSignals');
    const signalsBody = document.getElementById('signalsBody');
    const titleSymbol = document.getElementById('titleSymbol');
    const maxEl = document.getElementById('maxVal'), minEl = document.getElementById('minVal'), closeEl = document.getElementById('closeVal');
    const fullscreenBtn = document.getElementById('fullscreen');
    const fullscreenExitBtn = document.getElementById('fullscreenBtn');

    // ----- Lightweight chart setup -----
    let chart = null, candleSeries = null;
    let lastCandles = [];

    function initChart() {
      if (chart) { chart.remove(); chart = null; candleSeries = null; }
      // create chart
      chart = LightweightCharts.createChart(chartContainer, {
        layout: { backgroundColor: '#ffffff', textColor: '#191919' },
        width: chartContainer.clientWidth, height: chartContainer.clientHeight,
        rightPriceScale: { visible: true },
        timeScale: { timeVisible: true, secondsVisible: false }
      });
      candleSeries = chart.addCandlestickSeries();
      window.addEventListener('resize', () => chart.applyOptions({ width: chartContainer.clientWidth, height: chartContainer.clientHeight }));
    }

    // draw candle array format: [{time: '2025-09-23T12:00:00Z', open:.., high:.., low:.., close:..}, ...]
    function plotCandles(candles) {
      if (!chart) initChart();
      const data = candles.map(c => {
        // Lightweight-charts expects 'time' as ISO without Z for minute-based, or epoch; library accepts ISO RFC3339 as string in many builds
        return {
          time: (new Date(c.time)).toISOString(),
          open: Number(c.open),
          high: Number(c.high),
          low: Number(c.low),
          close: Number(c.close)
        };
      });
      candleSeries.setData(data);
      lastCandles = data;
      updateMetrics(data);
      statusText.innerText = `Loaded ${data.length} candles`;
    }

    function updateMetrics(data){
      if (!data || data.length===0) {
        maxEl.innerText = minEl.innerText = closeEl.innerText = '-';
        return;
      }
      let max = -Infinity, min = Infinity;
      data.forEach(d => { if (d.high>max) max=d.high; if (d.low<min) min=d.low; });
      maxEl.innerText = round(max); minEl.innerText = round(min);
      closeEl.innerText = round(data[data.length-1].close);
    }
    function round(n){ return (Math.round(n*1000)/1000).toString(); }

    // ----- Fetch candles from backend -----
    async function fetchCandles(symbol, interval, limit=200){
      const url = `${BACKEND_BASE}/ict/candles?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${limit}`;
      statusText.innerText = 'fetching candles...';
      try {
        const res = await fetch(url, { method:'GET' });
        if (!res.ok) {
          const txt = await res.text();
          console.error('Backend returned error', res.status, txt);
          statusText.innerText = `backend error ${res.status}`;
          return null;
        }
        const json = await res.json();
        console.log('candles response', json);
        if (json && json.candles) return json.candles;
        // handle some backends returning 'data' or [] 
        if (json && Array.isArray(json)) return json;
        return null;
      } catch (err) {
        console.error('fetchCandles error', err);
        statusText.innerText = 'fetch error';
        return null;
      }
    }

    // ----- TradingView widget toggle -----
    let tvLoaded = false;
    function showTradingView(symbol){
      // hide lightweight chart & show TV container
      chartContainer.style.display = 'none';
      tvContainer.style.display = 'block';
      toggleTVBtn.innerText = 'LW Chart';
      if (!tvLoaded) {
        // TradingView official widget embed
        const script = document.createElement('script');
        script.src = "https://s3.tradingview.com/tv.js";
        script.onload = () => {
          new TradingView.widget({
            "width": "100%",
            "height": "100%",
            "symbol": symbol || "OANDA:XAUUSD",
            "interval": intervalSelect.value.replace('min',''),
            "timezone": "Etc/UTC",
            "theme": "light",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "allow_symbol_change": true,
            "container_id": "tvContainer"
          });
        };
        document.body.appendChild(script);
        tvLoaded = true;
      }
    }

    function showLightweight(){
      chartContainer.style.display = 'block';
      tvContainer.style.display = 'none';
      toggleTVBtn.innerText = 'TV';
    }

    // ----- Signals / Mentor (demo) -----
    function updateSignals(list){
      signalsBody.innerHTML = '';
      if (!list || list.length===0) {
        signalsBody.innerHTML = '<div class="signal">No signals</div>';
        return;
      }
      list.forEach(s => {
        const el = document.createElement('div');
        el.className = 'signal';
        el.innerHTML = `<div><strong>${s.type||'SIGNAL'}</strong> ${s.desc||''}</div><div style="font-size:12px;color:#444;margin-top:6px">${s.time||''}</div>`;
        signalsBody.appendChild(el);
      });
    }

    // Demo: load sample signals (replace by real backend call)
    function loadSignalsDemo(){
      const demo = [
        { type:'BUY', desc:'Demo buy at 3742.5', time: new Date().toISOString() },
        { type:'SELL', desc:'Demo sell at 3730.0', time: new Date().toISOString() }
      ];
      updateSignals(demo);
    }

    // ----- CSV export -----
    function exportCSV(){
      if (!lastCandles || lastCandles.length===0) { alert('No candles to export'); return; }
      const rows = [['time','open','high','low','close']];
      lastCandles.forEach(d => rows.push([d.time, d.open, d.high, d.low, d.close]));
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${symbolInput.value||'symbol'}_${intervalSelect.value}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ----- Fullscreen handling -----
    function goFullscreen(){
      const el = document.getElementById('chart-wrap');
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      fullscreenExitBtn.style.display = 'block';
    }
    function exitFullscreen(){
      if (document.exitFullscreen) document.exitFullscreen();
      fullscreenExitBtn.style.display = 'none';
    }
    fullscreenBtn.addEventListener('click', goFullscreen);
    fullscreenExitBtn.addEventListener('click', exitFullscreen);

    // ----- Drag support for signals panel -----
    (function makeDraggable(){
      const dragHead = document.querySelector('#signalsPanel .draggable');
      const panel = document.getElementById('signalsPanel');
      if (!dragHead) return;
      let active=false, startX=0, startY=0, origLeft=0, origTop=0;
      dragHead.style.cursor='move';
      dragHead.addEventListener('mousedown', e => {
        active = true; startX = e.clientX; startY = e.clientY;
        const rect = panel.getBoundingClientRect();
        origLeft = rect.left; origTop = rect.top;
        panel.style.position = 'fixed'; panel.style.zIndex = 9999;
      });
      window.addEventListener('mousemove', e => {
        if (!active) return;
        const dx = e.clientX - startX, dy = e.clientY - startY;
        panel.style.left = (origLeft + dx) + 'px';
        panel.style.top = (origTop + dy) + 'px';
      });
      window.addEventListener('mouseup', ()=> active=false);
    })();

    // ----- event bindings -----
    loadBtn.addEventListener('click', async () => {
      const sym = (symbolInput.value||'XAUUSD').trim();
      titleSymbol.innerText = sym;
      const interval = intervalSelect.value;
      statusText.innerText = 'loading...';
      const candles = await fetchCandles(sym, interval, 500);
      if (candles && candles.length>0) {
        plotCandles(candles);
      } else {
        statusText.innerText = 'no data';
        console.warn('no candles fetched for', sym, interval);
      }
    });

    toggleTVBtn.addEventListener('click', () => {
      if (tvContainer.style.display === 'block') showLightweight();
      else showTradingView(symbolInput.value ? `OANDA:${symbolInput.value}` : 'OANDA:XAUUSD');
    });

    showHideSignalsBtn.addEventListener('click', () => {
      if (signalsBody.style.display === 'none') { signalsBody.style.display = 'block'; showHideSignalsBtn.innerText='Hide'; }
      else { signalsBody.style.display = 'none'; showHideSignalsBtn.innerText='Show'; }
    });

    document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
    document.getElementById('btnMaxMin').addEventListener('click', () => {
      alert(`Max: ${maxEl.innerText}\nMin: ${minEl.innerText}\nClose: ${closeEl.innerText}`);
    });
    document.getElementById('btnToggleTheme').addEventListener('click', (ev)=> {
      const cur = ev.target.innerText;
      if (cur === 'Dark') {
        chart.applyOptions({ layout:{ backgroundColor:'#001428', textColor:'#fff' } }); ev.target.innerText='Light';
      } else {
        chart.applyOptions({ layout:{ backgroundColor:'#fff', textColor:'#191919' } }); ev.target.innerText='Dark';
      }
    });

    document.getElementById('refreshMentor').addEventListener('click', ()=> {
      // placeholder: request AI mentor summary from backend
      document.getElementById('mentorText').innerText = 'AI Mentor refreshed (demo).';
    });

    // load demo signals
    loadSignalsDemo();

    // init
    initChart();
    // auto-load initial
    loadBtn.click();

    // expose for debugging in console
    window.__ICT = { initChart, plotCandles, fetchCandles, lastCandles };

  })();
  </script>
</body>
</html>
